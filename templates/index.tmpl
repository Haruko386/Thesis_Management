<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®ºæ–‡ç®¡ç†ç³»ç»Ÿ - PaperHub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ç®€å•çš„æ·¡å…¥æ·¡å‡ºåŠ¨ç”» */
        .fade-enter {
            opacity: 0;
            transform: translateY(-10px);
        }
        .fade-enter-active {
            opacity: 1;
            transform: translateY(0);
            transition: opacity 0.2s, transform 0.2s;
        }
    </style>
</head>
<body class="h-screen flex flex-col bg-gray-50">

<header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-6 z-20 shadow-sm">
    <div class="flex items-center gap-4">
        <button id="toggleBtn" class="text-gray-500 hover:text-blue-600 transition md:hidden">
            <i class="fas fa-bars text-xl"></i>
        </button>
        <h1 class="text-xl font-bold tracking-tight text-gray-800 flex items-center gap-2">
            <i class="fas fa-book-open text-blue-600"></i>
            Paper<span class="text-blue-600">Hub</span>
        </h1>
    </div>

    <div class="flex items-center gap-4 relative">
        <div class="relative group">
            <button id="userMenuBtn"
                    class="w-10 h-10 rounded-full bg-gray-100 border border-gray-200 flex items-center justify-center text-gray-500 hover:bg-gray-200 transition focus:outline-none overflow-hidden ring-2 ring-transparent hover:ring-blue-100">
                {{if .isLogin}}
                    <img src="/asset/admin.png" class="w-full h-full object-cover" alt="admin">
                {{else}}
                    <i class="fas fa-user"></i>
                {{end}}
            </button>

            <div id="userDropdown"
                 class="hidden absolute right-0 mt-2 w-56 bg-white rounded-xl shadow-xl border border-gray-100 py-2 z-50 transform origin-top-right transition-all">
                {{if .isLogin}}
                    <div class="px-4 py-3 border-b border-gray-100 bg-gray-50/50">
                        <p class="text-xs text-gray-500 font-medium uppercase tracking-wider">Signed in as</p>
                        <p class="text-sm font-bold text-gray-800 truncate mt-1">{{.user}}</p>
                    </div>
                    <a href="/logout"
                       class="flex items-center px-4 py-3 text-sm text-gray-700 hover:bg-red-50 hover:text-red-600 transition group">
                        <i class="fas fa-sign-out-alt mr-3 text-gray-400 group-hover:text-red-500"></i> é€€å‡ºç™»å½•
                    </a>
                {{else}}
                    <a href="/login"
                       class="flex items-center px-4 py-3 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition group">
                        <i class="fas fa-sign-in-alt mr-3 text-gray-400 group-hover:text-blue-500"></i> ç™»å½•ç³»ç»Ÿ
                    </a>
                {{end}}
            </div>
        </div>
    </div>
</header>

<div class="flex flex-1 overflow-hidden">
    <aside id="sidebar" class="hidden md:flex w-64 bg-white border-r border-gray-200 flex-col transition-all duration-300">
        <div class="p-6">
            <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4 px-2">Categories</p>
            <nav class="space-y-1">
                <a href="/?c=å…¨éƒ¨"
                   class="group flex items-center px-3 py-2.5 text-sm font-medium rounded-lg transition-colors {{if eq .currentCls "å…¨éƒ¨"}}bg-blue-50 text-blue-700{{else}}text-gray-600 hover:bg-gray-100{{end}}">
                    <i class="fas fa-layer-group w-5 {{if eq .currentCls "å…¨éƒ¨"}}text-blue-600{{else}}text-gray-400{{end}}"></i>
                    <span>å…¨éƒ¨</span>
                    <span class="ml-auto bg-gray-100 text-gray-600 py-0.5 px-2.5 rounded-full text-xs font-semibold group-hover:bg-white border border-transparent group-hover:border-gray-200">{{.totalCount}}</span>
                </a>

                {{range $name, $count := .categories}}
                    <a href="/?c={{$name}}"
                       class="group flex items-center px-3 py-2.5 text-sm font-medium rounded-lg transition-colors
                       {{if eq $.currentCls $name}}bg-blue-50 text-blue-700{{else}}text-gray-600 hover:bg-gray-100{{end}}">
                        <i class="fas fa-folder-open w-5 {{if eq $.currentCls $name}}text-blue-600{{else}}text-gray-400{{end}}"></i>
                        <span class="truncate">{{$name}}</span>
                        <span class="ml-auto bg-gray-100 text-gray-600 py-0.5 px-2.5 rounded-full text-xs font-semibold group-hover:bg-white border border-transparent group-hover:border-gray-200">
                            {{$count}}
                        </span>
                    </a>
                {{end}}
            </nav>
        </div>
        <div class="mt-auto p-4 border-t border-gray-100 text-xs text-gray-400 text-center">
            PaperHub v1.0.0 Alpha
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto bg-gray-50 p-6 md:p-8">
        <div class="max-w-5xl mx-auto">
            <div class="flex flex-col sm:flex-row sm:items-end justify-between mb-8 gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900 tracking-tight">æ‰€æœ‰è®ºæ–‡</h2>
                    <p class="text-sm text-gray-500 mt-1 flex items-center gap-2">
                        <span class="bg-gray-200 text-gray-600 px-2 py-0.5 rounded text-xs font-medium">{{.currentCls}}</span>
                        <span>å…±æ‰¾åˆ° {{len .theses}} ç¯‡æ–‡æ¡£</span>
                    </p>
                </div>

                <div class="flex items-center gap-3">
                    <div class="relative relative-sort-menu">
                        <button id="sortBtn" class="flex items-center gap-2 bg-white border border-gray-300 px-4 py-2 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 hover:border-gray-400 transition shadow-sm">
                            <span>Sort</span>
                            <i class="fas fa-caret-down text-gray-400"></i>
                        </button>

                        <div id="sortDropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl border border-gray-100 py-1 z-30">
                            <div class="flex justify-between items-center px-4 py-2 border-b border-gray-100">
                                <span class="text-xs font-semibold text-gray-900">Select order</span>
                                <i class="fas fa-times text-gray-400 cursor-pointer text-xs hover:text-gray-600" onclick="document.getElementById('sortDropdown').classList.add('hidden')"></i>
                            </div>

                            <div class="py-1">
                                <a href="#" data-sort="newest" class="sort-option group flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-700">
                                    <span class="w-6 flex items-center justify-center icon-area"></span>
                                    <span>Last updated</span>
                                </a>
                                <a href="#" data-sort="title" class="sort-option group flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-700">
                                    <span class="w-6 flex items-center justify-center icon-area"></span>
                                    <span>Title (A-Z)</span>
                                </a>
                                <a href="#" data-sort="date" class="sort-option group flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-700">
                                    <span class="w-6 flex items-center justify-center icon-area"></span>
                                    <span>Public Date</span>
                                </a>
                            </div>
                        </div>
                    </div>

                    {{if .isLogin}}
                        <a href="/upload"
                           class="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium shadow-sm transition transform active:scale-95">
                            <i class="fas fa-plus"></i>
                            <span class="hidden sm:inline">New Paper</span>
                            <span class="sm:hidden">New</span>
                        </a>
                    {{else}}
                        <a href="/login"
                           class="bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium shadow-sm transition">
                            Login to Upload
                        </a>
                    {{end}}
                </div>
            </div>

            <div class="grid gap-6">
                {{if .theses}}
                    {{range .theses}}
                        <div class="group bg-white rounded-xl border border-gray-200 shadow-sm hover:shadow-md hover:border-blue-200 transition-all duration-300 overflow-hidden flex h-40 sm:h-48">
                            <div class="w-28 sm:w-40 h-full bg-gray-100 flex-shrink-0 border-r border-gray-100 overflow-hidden relative">
                                <img src="/paper/cover/{{.ID}}" alt="cover"
                                     class="w-full h-full object-cover object-top group-hover:scale-105 transition duration-500">
                                <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-5 transition duration-300"></div>
                            </div>

                            <div class="flex-1 p-4 sm:p-6 flex flex-col justify-between">
                                <div>
                                    <div class="flex justify-between items-start">
                                        <div class="min-w-0 pr-3">
                                            <div class="flex flex-wrap gap-2 mb-2">
                                                {{range $i := .ClassificationList}}
                                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-bold bg-blue-50 text-blue-700 uppercase tracking-wide border border-blue-100">
                                                        {{$i}}
                                                    </span>
                                                {{end}}
                                            </div>
                                            <h3 class="text-lg sm:text-xl font-bold text-gray-800 group-hover:text-blue-600 cursor-pointer line-clamp-1 sm:line-clamp-2 transition-colors"
                                                onclick="window.location.href='/thesis/{{.ID}}'">
                                                {{.Title}}
                                            </h3>
                                        </div>

                                        <div class="flex gap-1 flex-shrink-0 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                                            {{if $.isLogin}}
                                                <button class="w-8 h-8 rounded-full hover:bg-blue-50 text-gray-400 hover:text-blue-600 transition flex items-center justify-center"
                                                        onclick="window.location.href='/edit/{{.ID}}'"
                                                        title="Edit">
                                                    <i class="fas fa-pencil-alt text-sm"></i>
                                                </button>
                                                <button class="w-8 h-8 rounded-full hover:bg-red-50 text-gray-400 hover:text-red-600 transition flex items-center justify-center"
                                                        onclick="deletePaper({{.ID}})"
                                                        title="Delete">
                                                    <i class="fas fa-trash-alt text-sm"></i>
                                                </button>
                                            {{end}}
                                        </div>
                                    </div>

                                    <p class="text-gray-500 text-sm mt-1 line-clamp-1">
                                        {{if .Journal}}<span class="font-serif italic text-gray-600">{{.Journal}}</span>{{else}}<span class="text-gray-400">Arxiv Preprint</span>{{end}}
                                    </p>
                                </div>

                                <div class="flex items-center text-xs text-gray-400 border-t border-gray-50 pt-3 mt-2">
                                    <span class="flex items-center"><i class="far fa-user mr-1.5"></i> {{.Author}}</span>
                                    <span class="mx-3 text-gray-200">|</span>
                                    <span class="flex items-center"><i class="far fa-calendar-alt mr-1.5"></i> {{.PublicDate.Format "2006-01-02"}}</span>
                                </div>
                            </div>
                        </div>
                    {{end}}
                {{else}}
                    <div class="bg-white rounded-xl border-2 border-dashed border-gray-200 flex flex-col items-center justify-center py-16 text-center">
                        <div class="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mb-4">
                            <i class="fas fa-search text-gray-300 text-2xl"></i>
                        </div>
                        <h3 class="text-gray-900 font-medium">No papers found</h3>
                        <p class="text-gray-500 text-sm mt-1">Try adjusting your category filter.</p>
                    </div>
                {{end}}
            </div>
        </div>
    </main>
</div>

<footer class="h-10 bg-white border-t border-gray-200 flex items-center justify-between px-6 text-xs text-gray-500">
    <div>Â©Haruko386 ğŸ“ all right reserved</div>
    <div class="flex gap-4">
        <span>æ•°æ®åº“è®¿é—®æƒé™:
        {{if .isLogin}}
            <span class="text-green-500">â— å·²è¿æ¥</span>
        {{else}}
            <span class="text-red-500">â— æœªè¿æ¥</span>
        {{end}}
        </span>
    </div>
</footer>

<script type="module" src="/static/js/index.js"></script>
<script>
    /* ================= ç”¨æˆ·èœå•é€»è¾‘ ================= */
    const userBtn = document.getElementById('userMenuBtn');
    const userDropdown = document.getElementById('userDropdown');

    // ç‚¹å‡»åˆ‡æ¢
    userBtn?.addEventListener('click', (e) => {
        e.stopPropagation();
        userDropdown.classList.toggle('hidden');
        if(!userDropdown.classList.contains('hidden')) {
            // å…³é—­å…¶ä»–å¯èƒ½æ‰“å¼€çš„èœå•
            sortDropdown.classList.add('hidden');
        }
    });

    /* ================= æ’åºèœå•é€»è¾‘ (æ–°å¢) ================= */
    const sortBtn = document.getElementById('sortBtn');
    const sortDropdown = document.getElementById('sortDropdown');

    // 1. ç‚¹å‡»åˆ‡æ¢æ’åºèœå•
    sortBtn?.addEventListener('click', (e) => {
        e.stopPropagation();
        sortDropdown.classList.toggle('hidden');
        if(!sortDropdown.classList.contains('hidden')) {
            userDropdown.classList.add('hidden');
        }
    });

    // 2. ç‚¹å‡»å¤–éƒ¨å…³é—­æ‰€æœ‰èœå•
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.group') && !e.target.closest('.relative-sort-menu')) {
            userDropdown.classList.add('hidden');
            sortDropdown.classList.add('hidden');
        }
    });

    // 3. å¤„ç†æ’åºå‚æ•°å’ŒUIçŠ¶æ€
    document.addEventListener('DOMContentLoaded', () => {
        // è·å–å½“å‰ URL å‚æ•°
        const params = new URLSearchParams(window.location.search);
        const currentSort = params.get('sort') || 'newest'; // é»˜è®¤ä¸º 'newest'

        // éå†æ‰€æœ‰æ’åºé€‰é¡¹
        const sortOptions = document.querySelectorAll('.sort-option');
        sortOptions.forEach(option => {
            const sortType = option.dataset.sort;
            const iconArea = option.querySelector('.icon-area');

            // æ„å»ºæ–°çš„ URLï¼ˆä¿ç•™ c=category å‚æ•°ï¼Œæ›´æ–° sort å‚æ•°ï¼‰
            const newParams = new URLSearchParams(window.location.search);
            newParams.set('sort', sortType);
            option.href = '?' + newParams.toString();

            // å¦‚æœæ˜¯å½“å‰é€‰ä¸­çš„æ’åºæ–¹å¼
            if (sortType === currentSort) {
                iconArea.innerHTML = '<i class="fas fa-check text-blue-600"></i>';
                option.classList.add('bg-blue-50', 'text-blue-700');
            }
        });

        // æ›´æ–°æŒ‰é’®ä¸Šçš„æ–‡æœ¬ï¼ˆå¯é€‰ï¼‰
        const activeText = document.querySelector(`.sort-option[data-sort="${currentSort}"] span:last-child`)?.innerText;
        // if(activeText) document.querySelector('#sortBtn span').innerText = "Sort: " + activeText;
    });

    /* ================= åˆ é™¤é€»è¾‘ ================= */
    function deletePaper(id) {
        if (!confirm("ç¡®è®¤åˆ é™¤è¿™ç¯‡è®ºæ–‡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤")) {
            return;
        }

        fetch(`/api/delete/${id}`, {
            method: 'DELETE'
        })
            .then(res => res.json())
            .then(data => {
                alert(data.message || "åˆ é™¤æˆåŠŸ");
                location.reload();
            })
            .catch(err => {
                alert("åˆ é™¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æƒé™");
                console.error(err);
            });
    }
</script>
</body>
</html>